name: Deploy CleverKeys Web Demo

on:
  push:
    branches: [ main ]
    paths: [ 'web_demo/**', 'README.md' ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Ensure LFS files
        run: git lfs install && git lfs pull

      - name: Prepare CleverKeys neural swipe demo
        run: |
          mkdir -p deploy

          # Copy complete web demo with ONNX neural swipe functionality
          if [ -d "web_demo" ]; then
            echo "📁 Copying CleverKeys neural swipe demo..."
            cp web_demo/* deploy/ 2>/dev/null || echo "No web demo files"

            # Rename swipe-onnx.html to index.html for direct access
            if [ -f "deploy/swipe-onnx.html" ]; then
              mv deploy/swipe-onnx.html deploy/index.html
              echo "✅ Set swipe-onnx.html as homepage"
            fi
          fi

          echo "✅ Neural swipe demo prepared"
          ls -la deploy/

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./deploy

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4